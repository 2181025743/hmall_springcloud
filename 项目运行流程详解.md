# HMall ç”µå•†å¾®æœåŠ¡ç³»ç»Ÿè¿è¡Œæµç¨‹è¯¦è§£

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```
å‰ç«¯ (localhost:18080)
    â†“ HTTPè¯·æ±‚
hm-gateway (8080) - APIç½‘å…³
    â†“ è·¯ç”±è½¬å‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                å¾®æœåŠ¡é›†ç¾¤                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ item-service    å•†å“æœåŠ¡                         â”‚
â”‚ cart-service    è´­ç‰©è½¦æœåŠ¡ (8082)                â”‚
â”‚ user-service    ç”¨æˆ·æœåŠ¡                         â”‚
â”‚ trade-service   äº¤æ˜“è®¢å•æœåŠ¡                     â”‚
â”‚ pay-service     æ”¯ä»˜æœåŠ¡                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ æ³¨å†Œå‘ç°
Nacos (101.42.238.233:8848)
    â†“ ç›‘æ§
Sentinel Dashboard (localhost:8858)
```

## ğŸ“‹ å®Œæ•´ä¸šåŠ¡æµç¨‹ï¼šä»æœç´¢åˆ°ä¸‹å•æ”¯ä»˜

### åœºæ™¯ï¼šç”¨æˆ·åœ¨æœç´¢é¡µæ·»åŠ å•†å“åˆ°è´­ç‰©è½¦ï¼Œç„¶åå•†å“é™ä»·åä¸‹å•çš„å®Œæ•´æµç¨‹

---

## ğŸ” ç¬¬ä¸€æ­¥ï¼šå•†å“æœç´¢

### 1.1 ç”¨æˆ·å‘èµ·æœç´¢è¯·æ±‚
```
ç”¨æˆ·åœ¨å‰ç«¯è¾“å…¥å…³é”®è¯ï¼šä¾‹å¦‚"æ‰‹æœº"
å‰ç«¯å‘é€HTTPè¯·æ±‚ï¼šGET /search/list?key=æ‰‹æœº&page=1&size=10
```

### 1.2 ç½‘å…³å¤„ç†
```java
// hm-gateway æ¥æ”¶è¯·æ±‚
è¯·æ±‚è·¯å¾„: http://localhost:8080/search/list?key=æ‰‹æœº
ç½‘å…³é…ç½®:
  - è·¯å¾„åŒ¹é…: /search/**
  - è½¬å‘ç›®æ ‡: lb://item-service
  - æœ€ç»ˆè½¬å‘: http://item-service/search/list?key=æ‰‹æœº
```

### 1.3 å•†å“æœåŠ¡å¤„ç†æœç´¢
```java
// item-service/SearchController.java:26
@GetMapping("/list")
public PageDTO<ItemDTO> search(ItemPageQuery query) {
    // 1. æ•°æ®åº“æŸ¥è¯¢
    Page<Item> result = itemService.lambdaQuery()
        .like(StrUtil.isNotBlank(query.getKey()), Item::getName, query.getKey()) // æ¨¡ç³ŠåŒ¹é…å•†å“å
        .eq(Item::getStatus, 1) // åªæŸ¥åœ¨å”®å•†å“
        .page(query.toMpPage("update_time", false)); // åˆ†é¡µï¼ŒæŒ‰æ›´æ–°æ—¶é—´é™åº

    // 2. POè½¬DTOè¿”å›
    return PageDTO.of(result, ItemDTO.class);
}
```

### 1.4 æ•°æ®åº“æ‰§è¡Œ
```sql
-- å®é™…æ‰§è¡Œçš„SQLï¼ˆMyBatis-Plusç”Ÿæˆï¼‰
SELECT id,name,price,stock,image,category,brand,spec,sold,comment_count,isAD,status,create_time,update_time
FROM item
WHERE name LIKE '%æ‰‹æœº%'
  AND status = 1
ORDER BY update_time DESC
LIMIT 0,10
```

### 1.5 å“åº”æ•°æ®æµ
```
item-service â†’ hm-gateway â†’ å‰ç«¯
è¿”å›æ•°æ®æ ¼å¼:
{
  "total": 50,
  "pages": 5,
  "list": [
    {
      "id": 100001,
      "name": "Apple iPhone 15",
      "price": 5999,
      "stock": 100,
      "image": "xxx.jpg"
    }
  ]
}
```

---

## ğŸ›’ ç¬¬äºŒæ­¥ï¼šæ·»åŠ å•†å“åˆ°è´­ç‰©è½¦

### 2.1 ç”¨æˆ·ç‚¹å‡»åŠ å…¥è´­ç‰©è½¦
```
å‰ç«¯å‘é€è¯·æ±‚ï¼šPOST /carts
è¯·æ±‚ä½“: {
  "itemId": 100001,
  "num": 2
}
```

### 2.2 ç½‘å…³è·¯ç”±åˆ°è´­ç‰©è½¦æœåŠ¡
```java
// hm-gateway è·¯ç”±é…ç½®
è·¯å¾„åŒ¹é…: /carts/**
è½¬å‘ç›®æ ‡: lb://cart-service
æœ€ç»ˆè¯·æ±‚: http://cart-service/carts
```

### 2.3 è´­ç‰©è½¦æœåŠ¡å¤„ç†
```java
// cart-service/CartController.java:27
@PostMapping
public void addItem2Cart(@Valid @RequestBody CartFormDTO cartFormDTO) {
    cartService.addItem2Cart(cartFormDTO);
}

// cart-service/CartServiceImpl.java:42
@Override
public void addItem2Cart(CartFormDTO cartFormDTO) {
    // 1. è·å–å½“å‰ç™»å½•ç”¨æˆ·IDï¼ˆä»JWTä¸­è§£æï¼‰
    Long userId = UserContext.getUser(); // ä¾‹å¦‚ï¼šuserId = 2

    // 2. æ£€æŸ¥è´­ç‰©è½¦ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥å•†å“
    if (checkItemExists(cartFormDTO.getItemId(), userId)) {
        // 2.1 å­˜åœ¨åˆ™æ›´æ–°æ•°é‡ï¼ˆ+1ï¼‰
        baseMapper.updateNum(cartFormDTO.getItemId(), userId);
        return;
    }

    // 2.2 ä¸å­˜åœ¨åˆ™æ–°å¢è´­ç‰©è½¦è®°å½•
    // 3. **å…³é”®ç‚¹ï¼šè°ƒç”¨å•†å“æœåŠ¡è·å–å•†å“ä¿¡æ¯**
    ItemDTO item = itemClient.queryItemByIds(List.of(cartFormDTO.getItemId())).get(0);

    // 4. æ„é€ è´­ç‰©è½¦å¯¹è±¡å¹¶ä¿å­˜
    Cart cart = BeanUtils.copyBean(cartFormDTO, Cart.class);
    cart.setUserId(userId);
    cart.setName(item.getName());
    cart.setPrice(item.getPrice());
    cart.setImage(item.getImage());
    save(cart);
}
```

### 2.4 å¾®æœåŠ¡é—´è°ƒç”¨ï¼šcart-service â†’ item-service
```java
// è¿™é‡Œå°±æ˜¯æˆ‘ä»¬åˆšæ‰é…ç½®çš„Feignè°ƒç”¨ï¼Œå¸¦Fallbacké™çº§
// hm-api/ItemClient.java
@FeignClient(value = "item-service", fallbackFactory = ItemClientFallbackFactory.class)
public interface ItemClient {
    @GetMapping("/items")
    List<ItemDTO> queryItemByIds(@RequestParam("ids") Collection<Long> ids);
}

// å®é™…HTTPè°ƒç”¨è¿‡ç¨‹ï¼š
// 1. Feignç”Ÿæˆä»£ç†å¯¹è±¡
// 2. è°ƒç”¨: GET http://item-service/items?ids=100001
// 3. å¦‚æœå¤±è´¥ï¼Œè§¦å‘Fallbackè¿”å›ç©ºé›†åˆ
// 4. Sentinelç›‘æ§æ­¤æ¬¡è°ƒç”¨
```

### 2.5 å•†å“æœåŠ¡å“åº”å•†å“è¯¦æƒ…
```java
// item-service/ItemController.java:38
@GetMapping
public List<ItemDTO> queryItemByIds(@RequestParam("ids") List<Long> ids) {
    // æ¨¡æ‹Ÿå»¶è¿Ÿ500msï¼ˆæˆ‘ä»¬æ·»åŠ çš„æµ‹è¯•ä»£ç ï¼‰
    Thread.sleep(500);

    // æŸ¥è¯¢æ•°æ®åº“
    return itemService.queryItemByIds(ids);
}
```

### 2.6 æ•°æ®åº“æ“ä½œ
```sql
-- è´­ç‰©è½¦è¡¨æ’å…¥
INSERT INTO cart (user_id, item_id, name, price, image, num, create_time, update_time)
VALUES (2, 100001, 'Apple iPhone 15', 5999, 'xxx.jpg', 2, NOW(), NOW());
```

---

## ğŸ’° ç¬¬ä¸‰æ­¥ï¼šå•†å“é™ä»·ï¼ˆç®¡ç†åå°æ“ä½œï¼‰

### 3.1 ç®¡ç†å‘˜ä¿®æ”¹å•†å“ä»·æ ¼
```java
// item-service/ItemController.java:65
@PutMapping
public void updateItem(@RequestBody ItemDTO item) {
    // æ›´æ–°å•†å“ä¿¡æ¯ï¼ˆåŒ…æ‹¬ä»·æ ¼ï¼‰
    itemService.updateById(BeanUtils.copyBean(item, Item.class));
}
```

### 3.2 æ•°æ®åº“ä»·æ ¼æ›´æ–°
```sql
UPDATE item
SET price = 4999, update_time = NOW()
WHERE id = 100001;
-- iPhone 15 ä»5999é™ä»·åˆ°4999
```

---

## ğŸ›ï¸ ç¬¬å››æ­¥ï¼šç”¨æˆ·æŸ¥çœ‹è´­ç‰©è½¦

### 4.1 ç”¨æˆ·æ‰“å¼€è´­ç‰©è½¦é¡µé¢
```
å‰ç«¯è¯·æ±‚ï¼šGET /carts
```

### 4.2 è´­ç‰©è½¦æœåŠ¡å¤„ç†
```java
// cart-service/CartController.java:45
@GetMapping
public List<CartVO> queryMyCarts() {
    return cartService.queryMyCarts();
}

// cart-service/CartServiceImpl.java
@Override
public List<CartVO> queryMyCarts() {
    // 1. è·å–ç”¨æˆ·ID
    Long userId = UserContext.getUser();

    // 2. æŸ¥è¯¢ç”¨æˆ·è´­ç‰©è½¦
    List<Cart> carts = lambdaQuery().eq(Cart::getUserId, userId).list();
    if (CollUtils.isEmpty(carts)) {
        return CollUtils.emptyList();
    }

    // 3. **å…³é”®ï¼šå†æ¬¡è°ƒç”¨å•†å“æœåŠ¡è·å–æœ€æ–°å•†å“ä¿¡æ¯**
    Set<Long> itemIds = carts.stream().map(Cart::getItemId).collect(Collectors.toSet());
    List<ItemDTO> items = itemClient.queryItemByIds(itemIds);

    // 4. è½¬æ¢ä¸ºMapä¾¿äºæŸ¥æ‰¾
    Map<Long, ItemDTO> itemMap = items.stream()
        .collect(Collectors.toMap(ItemDTO::getId, Function.identity()));

    // 5. æ„å»ºè´­ç‰©è½¦VOï¼ŒåŒ…å«æœ€æ–°çš„å•†å“ä»·æ ¼
    List<CartVO> vos = BeanUtils.copyList(carts, CartVO.class);
    vos.forEach(v -> {
        ItemDTO item = itemMap.get(v.getItemId());
        if (item != null) {
            v.setNewPrice(item.getPrice()); // æœ€æ–°ä»·æ ¼4999
            v.setStatus(item.getStatus());
            v.setStock(item.getStock());
        }
    });

    return vos;
}
```

### 4.3 ç”¨æˆ·çœ‹åˆ°é™ä»·ä¿¡æ¯
```json
// è¿”å›ç»™å‰ç«¯çš„æ•°æ®
[
  {
    "id": 1,
    "itemId": 100001,
    "name": "Apple iPhone 15",
    "price": 5999,      // åŠ å…¥è´­ç‰©è½¦æ—¶çš„ä»·æ ¼
    "newPrice": 4999,   // å½“å‰æœ€æ–°ä»·æ ¼ï¼ˆé™ä»·äº†ï¼ï¼‰
    "num": 2,
    "image": "xxx.jpg"
  }
]
```

---

## ğŸ“‹ ç¬¬äº”æ­¥ï¼šåˆ›å»ºè®¢å•

### 5.1 ç”¨æˆ·ç‚¹å‡»ç»“ç®—
```
å‰ç«¯è¯·æ±‚ï¼šPOST /orders
è¯·æ±‚ä½“: {
  "cartIds": [1],  // è´­ç‰©è½¦æ¡ç›®ID
  "addressId": 123 // æ”¶è´§åœ°å€ID
}
```

### 5.2 ç½‘å…³è·¯ç”±åˆ°äº¤æ˜“æœåŠ¡
```
hm-gateway â†’ trade-service
```

### 5.3 è®¢å•æœåŠ¡åˆ›å»ºè®¢å•
```java
// trade-service/OrderController.java:29
@PostMapping
public Long createOrder(@RequestBody OrderFormDTO orderFormDTO){
    return orderService.createOrder(orderFormDTO);
}

// trade-service/OrderServiceImpl.java
@Override
public Long createOrder(OrderFormDTO orderFormDTO) {
    // 1. è·å–ç”¨æˆ·ID
    Long userId = UserContext.getUser();

    // 2. **è°ƒç”¨è´­ç‰©è½¦æœåŠ¡**è·å–è´­ç‰©è½¦å•†å“ä¿¡æ¯
    List<CartVO> carts = cartClient.queryCartByIds(orderFormDTO.getCartIds());

    // 3. **è°ƒç”¨å•†å“æœåŠ¡**è·å–æœ€æ–°å•†å“ä¿¡æ¯å’Œä»·æ ¼
    Set<Long> itemIds = carts.stream().map(CartVO::getItemId).collect(Collectors.toSet());
    List<ItemDTO> items = itemClient.queryItemByIds(itemIds);
    Map<Long, ItemDTO> itemMap = items.stream()
        .collect(Collectors.toMap(ItemDTO::getId, Function.identity()));

    // 4. è®¡ç®—è®¢å•é‡‘é¢ï¼ˆä½¿ç”¨æœ€æ–°ä»·æ ¼ï¼‰
    int totalFee = 0;
    for (CartVO cart : carts) {
        ItemDTO item = itemMap.get(cart.getItemId());
        totalFee += item.getPrice() * cart.getNum(); // 4999 * 2 = 9998
    }

    // 5. åˆ›å»ºè®¢å•ä¸»è®°å½•
    Order order = new Order();
    order.setId(IdWorker.getId()); // ç”Ÿæˆè®¢å•å·ï¼Œå¦‚ï¼š1836123456789
    order.setUserId(userId);
    order.setTotalFee(totalFee);
    order.setPaymentType(1);
    order.setStatus(1); // å¾…æ”¯ä»˜
    order.setCreateTime(LocalDateTime.now());
    save(order);

    // 6. åˆ›å»ºè®¢å•è¯¦æƒ…
    List<OrderDetail> details = new ArrayList<>();
    for (CartVO cart : carts) {
        OrderDetail detail = new OrderDetail();
        detail.setOrderId(order.getId());
        detail.setItemId(cart.getItemId());
        detail.setNum(cart.getNum());
        detail.setPrice(itemMap.get(cart.getItemId()).getPrice()); // ä½¿ç”¨æœ€æ–°ä»·æ ¼
        detail.setName(cart.getName());
        detail.setImage(cart.getImage());
        details.add(detail);
    }
    orderDetailService.saveBatch(details);

    // 7. **è°ƒç”¨è´­ç‰©è½¦æœåŠ¡**åˆ é™¤å·²ä¸‹å•çš„è´­ç‰©è½¦å•†å“
    cartClient.deleteCartItemByIds(orderFormDTO.getCartIds());

    // 8. **è°ƒç”¨å•†å“æœåŠ¡**æ‰£å‡åº“å­˜
    List<OrderDetailDTO> orderDetails = BeanUtils.copyList(details, OrderDetailDTO.class);
    itemClient.deductStock(orderDetails);

    return order.getId();
}
```

### 5.4 å¤šä¸ªå¾®æœåŠ¡åä½œ
```java
// è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠå¤šä¸ªæœåŠ¡è°ƒç”¨ï¼š

// 1. trade-service â†’ cart-service (æŸ¥è¯¢è´­ç‰©è½¦)
cartClient.queryCartByIds(orderFormDTO.getCartIds())

// 2. trade-service â†’ item-service (æŸ¥è¯¢å•†å“æœ€æ–°ä¿¡æ¯)
itemClient.queryItemByIds(itemIds)

// 3. trade-service â†’ cart-service (åˆ é™¤è´­ç‰©è½¦å•†å“)
cartClient.deleteCartItemByIds(orderFormDTO.getCartIds())

// 4. trade-service â†’ item-service (æ‰£å‡åº“å­˜)
itemClient.deductStock(orderDetails)
```

### 5.5 æ•°æ®åº“äº‹åŠ¡æ“ä½œ
```sql
-- è®¢å•ä¸»è¡¨
INSERT INTO `order` (id, user_id, total_fee, payment_type, status, create_time)
VALUES (1836123456789, 2, 9998, 1, 1, NOW());

-- è®¢å•è¯¦æƒ…è¡¨
INSERT INTO order_detail (order_id, item_id, num, price, name, image)
VALUES (1836123456789, 100001, 2, 4999, 'Apple iPhone 15', 'xxx.jpg');

-- æ‰£å‡å•†å“åº“å­˜
UPDATE item
SET stock = stock - 2
WHERE id = 100001 AND stock >= 2;

-- åˆ é™¤è´­ç‰©è½¦è®°å½•
DELETE FROM cart WHERE id IN (1);
```

---

## ğŸ’³ ç¬¬å…­æ­¥ï¼šæ”¯ä»˜æµç¨‹

### 6.1 ç”¨æˆ·é€‰æ‹©æ”¯ä»˜æ–¹å¼
```
å‰ç«¯è¯·æ±‚ï¼šPOST /pay-orders
è¯·æ±‚ä½“: {
  "bizOrderNo": 1836123456789, // ä¸šåŠ¡è®¢å•å·
  "amount": 9998,              // æ”¯ä»˜é‡‘é¢
  "payChannelCode": "zfb",     // æ”¯ä»˜æ¸ é“
  "payType": 1                 // ä½™é¢æ”¯ä»˜
}
```

### 6.2 æ”¯ä»˜æœåŠ¡ç”Ÿæˆæ”¯ä»˜å•
```java
// pay-service/PayController.java:24
@PostMapping
public String applyPayOrder(@RequestBody PayApplyDTO applyDTO){
    // æ£€æŸ¥åªæ”¯æŒä½™é¢æ”¯ä»˜
    if(!PayType.BALANCE.equalsValue(applyDTO.getPayType())){
        throw new BizIllegalException("æŠ±æ­‰ï¼Œç›®å‰åªæ”¯æŒä½™é¢æ”¯ä»˜");
    }
    return payOrderService.applyPayOrder(applyDTO);
}

// pay-service/PayOrderServiceImpl.java
@Override
public String applyPayOrder(PayApplyDTO applyDTO) {
    // 1. åˆ›å»ºæ”¯ä»˜å•
    PayOrder payOrder = new PayOrder();
    payOrder.setId(IdWorker.getId()); // ç”Ÿæˆæ”¯ä»˜å•IDï¼š1836123456790
    payOrder.setBizOrderNo(applyDTO.getBizOrderNo()); // å…³è”ä¸šåŠ¡è®¢å•å·
    payOrder.setAmount(applyDTO.getAmount());
    payOrder.setPayChannelCode(applyDTO.getPayChannelCode());
    payOrder.setStatus(PayStatus.WAIT_BUYER_PAY.getValue()); // ç­‰å¾…æ”¯ä»˜
    save(payOrder);

    return payOrder.getId().toString();
}
```

### 6.3 ç”¨æˆ·ç¡®è®¤æ”¯ä»˜
```
å‰ç«¯è¯·æ±‚ï¼šPOST /pay-orders/1836123456790
è¯·æ±‚ä½“: {
  "pw": "123456"  // æ”¯ä»˜å¯†ç 
}
```

### 6.4 ä½™é¢æ”¯ä»˜å¤„ç†
```java
// pay-service/PayController.java:35
@PostMapping("{id}")
public void tryPayOrderByBalance(@PathVariable("id") Long id, @RequestBody PayOrderFormDTO payOrderFormDTO){
    payOrderService.tryPayOrderByBalance(payOrderFormDTO);
}

// pay-service/PayOrderServiceImpl.java
@Override
public void tryPayOrderByBalance(PayOrderFormDTO payOrderFormDTO) {
    // 1. æŸ¥è¯¢æ”¯ä»˜å•
    PayOrder payOrder = getById(payOrderFormDTO.getId());

    // 2. **è°ƒç”¨ç”¨æˆ·æœåŠ¡**æ‰£å‡ç”¨æˆ·ä½™é¢
    userClient.deductMoney(payOrderFormDTO.getPw(), payOrder.getAmount());

    // 3. æ›´æ–°æ”¯ä»˜å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜
    payOrder.setStatus(PayStatus.TRADE_SUCCESS.getValue());
    payOrder.setPaySuccessTime(LocalDateTime.now());
    updateById(payOrder);

    // 4. **è°ƒç”¨äº¤æ˜“æœåŠ¡**é€šçŸ¥è®¢å•æ”¯ä»˜æˆåŠŸ
    tradeClient.markOrderPaySuccess(payOrder.getBizOrderNo());
}
```

### 6.5 è®¢å•çŠ¶æ€æ›´æ–°
```java
// trade-service æ¥æ”¶æ”¯ä»˜æˆåŠŸé€šçŸ¥
// trade-service/OrderController.java:36
@PutMapping("/{orderId}")
public void markOrderPaySuccess(@PathVariable("orderId") Long orderId) {
    orderService.markOrderPaySuccess(orderId);
}

// trade-service/OrderServiceImpl.java
@Override
public void markOrderPaySuccess(Long orderId) {
    // æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜
    Order order = new Order();
    order.setId(orderId);
    order.setStatus(2); // å¾…å‘è´§
    order.setPayTime(LocalDateTime.now());
    updateById(order);

    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–ä¸šåŠ¡é€»è¾‘ï¼Œå¦‚ï¼š
    // - å‘é€çŸ­ä¿¡é€šçŸ¥
    // - é€šçŸ¥ä»“åº“å‘è´§
    // - è®°å½•æ”¯ä»˜æ—¥å¿—ç­‰
}
```

---

## ğŸ”„ å¾®æœåŠ¡è°ƒç”¨é“¾è·¯å›¾

```
ç”¨æˆ·æœç´¢å•†å“ï¼š
å‰ç«¯ â†’ hm-gateway â†’ item-service â†’ æ•°æ®åº“

æ·»åŠ è´­ç‰©è½¦ï¼š
å‰ç«¯ â†’ hm-gateway â†’ cart-service â†’ item-service â†’ æ•°æ®åº“
                      â†“
                   æ•°æ®åº“(cartè¡¨)

æŸ¥çœ‹è´­ç‰©è½¦ï¼š
å‰ç«¯ â†’ hm-gateway â†’ cart-service â†’ item-service â†’ æ•°æ®åº“
                      â†“
                   è¿”å›æœ€æ–°ä»·æ ¼

åˆ›å»ºè®¢å•ï¼š
å‰ç«¯ â†’ hm-gateway â†’ trade-service â”¬â†’ cart-service â†’ æ•°æ®åº“
                                 â”œâ†’ item-service â†’ æ•°æ®åº“
                                 â””â†’ æ•°æ®åº“(orderè¡¨)

æ”¯ä»˜è®¢å•ï¼š
å‰ç«¯ â†’ hm-gateway â†’ pay-service â”¬â†’ user-service â†’ æ•°æ®åº“
                                â”œâ†’ trade-service â†’ æ•°æ®åº“
                                â””â†’ æ•°æ®åº“(pay_orderè¡¨)
```

## ğŸ›¡ï¸ å®¹é”™æœºåˆ¶

### Sentinel + Feign Fallback
- å½“ä»»ä½•å¾®æœåŠ¡è°ƒç”¨å¤±è´¥æ—¶ï¼Œè§¦å‘Fallbackæœºåˆ¶
- æŸ¥è¯¢ç±»æ“ä½œï¼šè¿”å›ç©ºæ•°æ®ï¼Œä¿è¯ç³»ç»Ÿå¯ç”¨
- å…³é”®ä¸šåŠ¡æ“ä½œï¼šè®°å½•æ—¥å¿—å¹¶æŠ›å¼‚å¸¸ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§

### ç¤ºä¾‹ï¼šå•†å“æœåŠ¡å¼‚å¸¸æ—¶
```java
// å¦‚æœitem-serviceå®•æœºæˆ–å“åº”è¶…æ—¶
// cart-serviceè°ƒç”¨item-serviceå¤±è´¥æ—¶:
List<ItemDTO> items = itemClient.queryItemByIds(itemIds);
// â†“ è§¦å‘Fallback
// ItemClientFallbackFactory.create() è¿”å›ç©ºé›†åˆ
// â†“ è´­ç‰©è½¦é¡µé¢æ˜¾ç¤ºå•†å“åŸºæœ¬ä¿¡æ¯ï¼Œä½†ä»·æ ¼å¯èƒ½ä¸æ˜¯æœ€æ–°çš„
```

---

## ğŸ“Š å…³é”®æ•°æ®æµè½¬

1. **ç”¨æˆ·ä¿¡æ¯**: JWT Token â†’ UserContext.getUser() â†’ å„æœåŠ¡è·å–å½“å‰ç”¨æˆ·
2. **å•†å“ä¿¡æ¯**: item-service â†’ å…¶ä»–æœåŠ¡ â†’ ä¿è¯ä»·æ ¼å’Œåº“å­˜å‡†ç¡®æ€§
3. **è®¢å•çŠ¶æ€**: trade-service â†’ pay-service â†’ trade-service (çŠ¶æ€åŒæ­¥)
4. **åº“å­˜æ‰£å‡**: trade-service â†’ item-service (åŸå­æ“ä½œ)

## ğŸ” æ€§èƒ½ä¼˜åŒ–ç‚¹

1. **ç¼“å­˜ç­–ç•¥**: å•†å“ä¿¡æ¯å¯ä»¥åŠ å…¥Redisç¼“å­˜
2. **æ•°æ®åº“ä¼˜åŒ–**: å…³é”®æŸ¥è¯¢æ·»åŠ ç´¢å¼•
3. **å¼‚æ­¥å¤„ç†**: éå…³é”®ä¸šåŠ¡å¯å¼‚æ­¥æ‰§è¡Œ
4. **è¿æ¥æ± **: æ•°æ®åº“å’ŒHTTPè¿æ¥æ± è°ƒä¼˜

è¿™å°±æ˜¯HMallç”µå•†ç³»ç»Ÿä»æœç´¢åˆ°æ”¯ä»˜çš„å®Œæ•´ä¸šåŠ¡æµç¨‹ï¼æ¯ä¸ªç¯èŠ‚éƒ½ä½“ç°äº†å¾®æœåŠ¡æ¶æ„çš„ç‰¹ç‚¹ï¼šæœåŠ¡æ‹†åˆ†ã€ç‹¬ç«‹éƒ¨ç½²ã€æœåŠ¡é—´é€šä¿¡ã€‚